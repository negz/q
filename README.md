# q  [![Godoc](https://img.shields.io/badge/godoc-reference-blue.svg)](https://godoc.org/github.com/negz/secret-volume) [![Travis](https://img.shields.io/travis/negz/secret-volume.svg?maxAge=300)](https://travis-ci.org/negz/q/)
A toy in-memory queueing service with a lot of plumbing. q exposes an arbitrary
number of in-memory FIFO queues via gRPC. Each queue supports add, peek, and pop
operations. Queues may be limited in size or unbounded.

Both queues and messages may be tagged. Queue tags may be updated, but message
tags (and messages in general) are immutable.

Of course, with all queues and their messages being stored in-memory, everything
will be forgotten when the `q` process dies. :)

# Components
* `q` - The main logic. Exposes a gRPC API on port 10002.
* `qrest` - Exposes a (mostly) automatically generated REST to gRPC gateway on port 80. See `rpc/proto/q.swagger.json` for the API spec.
* `qcli` - A commandline gRPC client.

# Metrics, logging, and management
`q` exposes Prometheus metrics via HTTP at `/metrics` on port 10003. We expose
the count of total enqueued and consumed messages, tagged by queue ID. Total
errors are also exposed, tagged by queue and error type. We only expose counts,
not gauges, because counts
[don't lose meaning when downsampled in a timeseries]( https://goo.gl/WTHgAq).

`qrest` also exposes Prometheus metrics at `/metrics` on port 80, but only the
process and Go runtime information Prometheus provides for free.

Both `q` and `qrest` provide terse JSON structured logs on stdout by default.
Run them with the `-d` flag for debug logging in a more human friendly format.

`q` can be terminated immediately by hitting `/quitquitquit` on its metrics
port. `qrest` can also be terminated by hitting `/quitquitquit` on its main
port.

# Building
You'll need working Go and Docker installs. This project has been tested and
built against Go 1.8.3. Clone the project and run the build script to compile
the binaries and create Docker images:
```
$ mkdir -p ${GOPATH}/src/github.com/negz
$ cd ${GOPATH}/src/github.com/negz
$ git clone git@github.com:negz/q
$ cd q
$ scripts/build.sh
```

# Testing
Take a look at the [Travis CI](https://travis-ci.org/negz/q/) project, or run
`scripts/test.sh`. Note that `test.sh` assumes you've setup your environment
per the build instructions.

# Generated code
Any directory with a `generate.go` file contains automatically generated code
generated by running `go generate`.

This code generation depends on tools that are not managed by dep. To regenerate
code you'll need to:
```
$ go get golang.org/x/tools/cmd/stringer
$ go get github.com/gogo/protobuf/protoc-gen-gogoslick
$ go get github.com/grpc-ecosystem/grpc-gateway/protoc-gen-grpc-gateway
$ go get github.com/grpc-ecosystem/grpc-gateway/protoc-gen-swagger
```

# Known issues
* The `NewMessage` protocol buffer message is not included in the generated
Swagger API docs. This makes it difficult to discover how to add new messages to
a queue.

# Example usage
```
$ qcli new MEMORY 10 -t cool=satellites
{
  "queue": {
    "meta": {
      "id": "01189abe-5fcb-488f-a32d-c59315fa3b21",
      "created": "2017-06-25T09:58:08.535425833Z",
      "tags": [
        {
          "key": "cool",
          "value": "satellites"
        }
      ]
    },
    "store": "MEMORY"
  }
}

$ echo sputnik|qcli add 01189abe-5fcb-488f-a32d-c59315fa3b21 -t origin=ussr
{
  "message": {
    "meta": {
      "id": "a4d5a758-7845-4cb0-9c13-f407b8af178b",
      "created": "2017-06-25T09:59:40.844615906Z",
      "tags": [
        {
          "key": "origin",
          "value": "ussr"
        }
      ]
    },
    "payload": "c3B1dG5pawo="
  }
}

$ echo dove|qcli add 01189abe-5fcb-488f-a32d-c59315fa3b21 -t origin=usa
{
  "message": {
    "meta": {
      "id": "6d4978d4-209e-4fb1-a409-d1e46f64fee3",
      "created": "2017-06-25T10:00:05.249403455Z",
      "tags": [
        {
          "key": "origin",
          "value": "germany"
        }
      ]
    },
    "payload": "ZG92ZQo="
  }
}

$ qcli.go pop 01189abe-5fcb-488f-a32d-c59315fa3b21
{
  "message": {
    "meta": {
      "id": "a4d5a758-7845-4cb0-9c13-f407b8af178b",
      "created": "2017-06-25T09:59:40.844615906Z",
      "tags": [
        {
          "key": "origin",
          "value": "ussr"
        }
      ]
    },
    "payload": "c3B1dG5pawo="
  }
}
```